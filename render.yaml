services:
  # Full Stack Web Application (Frontend + Backend in one service)
  - type: web
    name: feasset
    env: node
    plan: starter
    buildCommand: |
      echo "ğŸš€ Building Full-Stack Web Application..."
      echo "ğŸ“ Current directory:"
      pwd
      echo "ğŸ“ Directory contents:"
      ls -la
      echo "ğŸ“¦ Installing client dependencies..."
      cd client && npm install
      echo "ğŸ—ï¸ Building React frontend (outputs to ../server/public)..."
      npm run build
      echo "ğŸ“ Checking React build output in server/public..."
      ls -la ../server/public/
      echo "ğŸ“ Checking if index.html exists in server/public..."
      if [ -f "../server/public/index.html" ]; then
        echo "âœ… index.html found in server/public/"
        echo "ğŸ“ Also copying to server/dist for compatibility..."
        mkdir -p ../server/dist
        cp -r ../server/public/* ../server/dist/
        echo "ğŸ“ Verifying server/dist copy..."
        ls -la ../server/dist/
        echo "âœ… React build copied successfully"
      else
        echo "âŒ index.html NOT found in server/public/"
        echo "ğŸ“ Server/public directory contents:"
        ls -la ../server/public/
        echo "âŒ React build failed!"
        exit 1
      fi
      echo "ğŸ“¦ Installing server dependencies..."
      cd ../server && npm install
      echo "ğŸ—ï¸ Building Node.js backend..."
      npm run build
      echo "ğŸ—„ï¸ Generating Prisma client..."
      npx prisma generate
      echo "ğŸ“ Final directory structure:"
      find . -name "index.html" -type f
      echo "âœ… Full-stack build complete!"
    startCommand: |
      echo "ğŸš€ Starting Full-Stack Web Application..."
      cd server
      echo "ğŸ—„ï¸ Setting up database..."
      npx prisma db push --accept-data-loss
      echo "ğŸŒ± Seeding database..."
      npm run db:seed
      echo "ğŸŒ Starting web server..."
      npm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 8080
      - key: DATABASE_URL
        fromDatabase:
          name: homestay-db
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_REFRESH_SECRET
        generateValue: true
      - key: CORS_ORIGIN
        value: https://feasset.onrender.com

databases:
  - name: homestay-db
    plan: starter
    databaseName: homestay
    user: homestay_user
