services:
  # Full Stack Web Application (Frontend + Backend in one service)
  - type: web
    name: feasset
    env: node
    plan: starter
    buildCommand: |
      echo "🚀 Building Full-Stack Web Application..."
      echo "📁 Current directory:"
      pwd
      echo "📁 Directory contents:"
      ls -la
      echo "📦 Installing client dependencies..."
      cd client && npm install
      echo "🏗️ Building React frontend..."
      npm run build
      echo "📁 Checking React build output..."
      ls -la dist/
      echo "📁 Contents of dist directory:"
      ls -la dist/
      echo "📁 Checking if index.html exists in dist..."
      if [ -f "dist/index.html" ]; then
        echo "✅ index.html found in dist/"
        echo "📁 Creating server directories..."
        mkdir -p ../server/client
        mkdir -p ../server/dist
        echo "📁 Copying React build to server/client..."
        cp -r dist/* ../server/client/
        echo "📁 Copying React build to server/dist..."
        cp -r dist/* ../server/dist/
        echo "📁 Verifying copies..."
        echo "Server/client contents:"
        ls -la ../server/client/
        echo "Server/dist contents:"
        ls -la ../server/dist/
        echo "✅ React build copied successfully"
      else
        echo "❌ index.html NOT found in dist/"
        echo "📁 Dist directory contents:"
        ls -la dist/
        echo "❌ React build failed!"
        exit 1
      fi
      echo "📦 Installing server dependencies..."
      cd ../server && npm install
      echo "🏗️ Building Node.js backend..."
      npm run build
      echo "🗄️ Generating Prisma client..."
      npx prisma generate
      echo "📁 Final directory structure:"
      find . -name "index.html" -type f
      echo "✅ Full-stack build complete!"
    startCommand: |
      echo "🚀 Starting Full-Stack Web Application..."
      cd server
      echo "🗄️ Setting up database..."
      npx prisma db push --accept-data-loss
      echo "🌱 Seeding database..."
      npm run db:seed
      echo "🌐 Starting web server..."
      npm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 8080
      - key: DATABASE_URL
        fromDatabase:
          name: homestay-db
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_REFRESH_SECRET
        generateValue: true
      - key: CORS_ORIGIN
        value: https://feasset.onrender.com

databases:
  - name: homestay-db
    plan: starter
    databaseName: homestay
    user: homestay_user
