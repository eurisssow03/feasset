services:
  # Full Stack Web Application (Frontend + Backend in one service)
  - type: web
    name: feasset
    env: node
    plan: starter
    buildCommand: |
      echo "🚀 Building Full-Stack Web Application..."
      echo "📁 Current directory:"
      pwd
      echo "📁 Directory contents:"
      ls -la
      echo "📦 Installing client dependencies..."
      cd client && npm install
      echo "🏗️ Building React frontend (outputs to ../server/public)..."
      npm run build
      echo "📁 Checking React build output in server/public..."
      ls -la ../server/public/
      echo "📁 Checking if index.html exists in server/public..."
      if [ -f "../server/public/index.html" ]; then
        echo "✅ index.html found in server/public/"
        echo "📁 Also copying to server/dist for compatibility..."
        mkdir -p ../server/dist
        cp -r ../server/public/* ../server/dist/
        echo "📁 Verifying server/dist copy..."
        ls -la ../server/dist/
        echo "✅ React build copied successfully"
      else
        echo "❌ index.html NOT found in server/public/"
        echo "📁 Server/public directory contents:"
        ls -la ../server/public/
        echo "❌ React build failed!"
        exit 1
      fi
      echo "📦 Installing server dependencies..."
      cd ../server && npm install
      echo "🏗️ Building Node.js backend..."
      npm run build
      echo "🗄️ Generating Prisma client..."
      npx prisma generate
      echo "📁 Final directory structure:"
      find . -name "index.html" -type f
      echo "✅ Full-stack build complete!"
    startCommand: |
      echo "🚀 Starting Full-Stack Web Application..."
      cd server
      echo "🗄️ Setting up database..."
      npx prisma db push --accept-data-loss
      echo "🌱 Seeding database..."
      npm run db:seed
      echo "🌐 Starting web server..."
      npm start
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 8080
      - key: DATABASE_URL
        fromDatabase:
          name: homestay-db
          property: connectionString
      - key: JWT_SECRET
        generateValue: true
      - key: JWT_REFRESH_SECRET
        generateValue: true
      - key: CORS_ORIGIN
        value: https://feasset.onrender.com

databases:
  - name: homestay-db
    plan: starter
    databaseName: homestay
    user: homestay_user
